<Project Sdk="Microsoft.NET.Sdk">
    <Import Project="$(SolutionDir)build\base.props"/>
    <Import Project="$(SolutionDir)build\build_variables.targets"/>

    <PropertyGroup>
        <OutputType>Exe</OutputType>
        <RootNamespace>ModSync</RootNamespace>
        <Configurations>Debug;Release;Debug Run ClientServer;Debug Run Client;Release Archive;ReleaseBeta Archive</Configurations>
        <Platforms>AnyCPU</Platforms>
        <TargetFramework>net8.0</TargetFramework>
    </PropertyGroup>

    <ItemGroup>
        <!--   All main projects     -->
        <ProjectReference Include="..\ValheimRAFT\ValheimRAFT.csproj"/>
        <ProjectReference Include="..\Shared\Shared.csproj"/>
        <ProjectReference Include="..\ZdoWatcher\ZdoWatcher.csproj"/>
        <ProjectReference Include="..\DynamicLocations\DynamicLocations.csproj"/>
        <ProjectReference Include="..\ValheimVehicles\ValheimVehicles.csproj"/>
    </ItemGroup>

    <ItemGroup>
        <PackageReference Include="Json5Core" Version="1.0.12"/>
    </ItemGroup>

    <PropertyGroup>
        <PostInstallerEnabled>true</PostInstallerEnabled>
        <Optimize>false</Optimize>
        <OutputPath>bin\$(Configuration)\</OutputPath>
        <!-- Define path variables for consistency across all projects -->
        <ModPostInstallerDir>$(SolutionDir)src\ModPostInstaller</ModPostInstallerDir>
        <ModOutputDir>$(ModPostInstallerDir)\bin\$(Configuration)\$(TargetFramework)\ModVersions</ModOutputDir>
        <DLLFromRoot>src\ModPostInstaller\bin\$(Configuration)\$(TargetFramework)\ModPostInstaller.dll</DLLFromRoot>
    </PropertyGroup>

    <!-- Consolidated RunPostInstaller target -->
    <!--    KeepDuplicateOutputs prevents caching of this        -->
    <Target Name="RunPostInstaller"
            KeepDuplicateOutputs="false"
            AfterTargets="Build"
            Condition=" '$(PostInstallerEnabled)' == 'true' AND '$(MSBuildProjectName)' != 'ModPostInstaller' ">
        <Message Text="TargetPath is: $(TargetPath)" Importance="high"/>
        <Message Text="SolutionDir is: $(SolutionDir)" Importance="high"/>
        <Message Text="OutDir is: $(OutDir)" Importance="high"/>
        <Message Text="Configuration is: $(Configuration)" Importance="high"/>
        <Message Text="Platform is: $(Platform)" Importance="high"/>
        <Message Text="IsRunnable is: $(IsRunnable)" Importance="high"/>
        <Message Text="IsRunnableServer is: $(IsRunnableServer)" Importance="high"/>
        <Message Text="PluginDeployPath is: $(PluginDeployPath)" Importance="high"/>
        <Message Text="ModPostInstallerDir is: $(ModPostInstallerDir)" Importance="high"/>
        <Message Text="ModOutputDir is: $(ModOutputDir)" Importance="high"/>

        <Exec Command="dotnet &quot;$(SolutionDir)$(DLLFromRoot)&quot; --solutionDir=&quot;$(SolutionDir)&quot;--outDir=&quot;$(OutDir)&quot; --config=&quot;$(Configuration)&quot; --assemblyName=&quot;$(AssemblyName)&quot; --modPostInstallerDir=&quot;$(ModPostInstallerDir)&quot; --modOutputDir=&quot;$(ModOutputDir)&quot; --isRunnable=&quot;$(IsRunnable)&quot; --isRunnableServer=&quot;$(IsRunnableServer)&quot; --pluginDeployPath=&quot;$(PluginDeployPath)&quot; --valheimServerPath=&quot;$(ValheimServerPath)&quot; --assetsDir=&quot;$(AssetsDir)&quot; --sandboxiePluginDeployPath=&quot;$(SandboxiePluginDeployPath)&quot; --applicationVersion=&quot;$(ApplicationVersion)&quot; --clientFileExitCode=%25ERRORLEVEL%25 $([System.String]::new(' ').PadRight(1)) --serverFileExitCode=%25ERRORLEVEL%25 $([System.String]::new(' ').PadRight(1)) --sandboxieFileExitCode=%25ERRORLEVEL%25"
              WorkingDirectory="$(SolutionDir)"
              IgnoreExitCode="true"/>
    </Target>

    <!--    <Import Project="$(SolutionDir)\build\game_launcher.targets"/>-->
</Project>