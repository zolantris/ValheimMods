<Project Sdk="Microsoft.NET.Sdk">
    <Import Project="$(SolutionDir)build\base.props"/>
    <Import Project="$(SolutionDir)build\build_variables.targets"/>
    <Import Project="$(SolutionDir)\build\game_launcher.targets"/>

    <ItemGroup>
        <!--   All main projects     -->
        <ProjectReference Include="..\ValheimRAFT\ValheimRAFT.csproj"/>
        <ProjectReference Include="..\Shared\Shared.csproj"/>
        <ProjectReference Include="..\ZdoWatcher\ZdoWatcher.csproj"/>
        <ProjectReference Include="..\DynamicLocations\DynamicLocations.csproj"/>
        <ProjectReference Include="..\ValheimVehicles\ValheimVehicles.csproj"/>
        <ProjectReference Include="..\ModSync\ModSync.csproj">
            <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
        </ProjectReference>
    </ItemGroup>

    <PropertyGroup>
        <PostInstallerEnabled>true</PostInstallerEnabled>
        <Optimize>false</Optimize>
        <OutputPath>bin\$(Configuration)\</OutputPath>
        <Configurations>Debug;Release;Debug Run ClientServer;Debug Run Client;Release Archive;ReleaseBeta Archive;ModSyncOnly</Configurations>
        <TargetFramework>Net8.0</TargetFramework>
        <Platforms>AnyCPU</Platforms>
    </PropertyGroup>

    <PropertyGroup Label="For target args generation">
        <SyncTargets Condition="'$(IsRunnableServer)' == 'true'">server</SyncTargets>
        <SyncTargets Condition="'$(IsRunnableClient)' == 'true'">localClient</SyncTargets>
        <!--  This overrides server or client config -->
        <SyncTargets Condition="'$(IsRunnableClientServer)' == 'true'">localClient,vmClient,server</SyncTargets>
    </PropertyGroup>

    <!-- Consolidated RunPostInstaller target -->
    <!--    KeepDuplicateOutputs prevents caching of this        -->
    <Target Name="RunPostInstaller"
            KeepDuplicateOutputs="false"
            AfterTargets="Build"
            Condition=" '$(PostInstallerEnabled)' == 'true' AND '$(SyncTargets)' != '' ">
        <Message Text="IsRunnableServer is: $(IsRunnableServer)" Importance="high"/>
        <Message Text="IsRunnableClient is: $(IsRunnableClient)" Importance="high"/>
        <Message Text="IsRunnableClientServer is: $(IsRunnableClientServer)" Importance="high"/>
        <Message Text="SyncTargets is: $(SyncTargets)" Importance="high"/>
        <Exec
                Command="dotnet &quot;$(ModSyncDll)&quot; sync --targets=&quot;$(SyncTargets)&quot;"
                WorkingDirectory="$(SolutionDir)"
                IgnoreExitCode="false"
        />
        <Message Text="Success" Importance="high"/>
    </Target>
</Project>
